<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#6750a4">
    
    <link rel="icon" type="image/png" href="icons/favicon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ ØµÙ„Ø§ØªÙŠ: Ù…ÙˆØ§Ù‚ÙŠØª ØµÙ„Ø§Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ ÙˆØ¬ÙˆØ¬Ù„ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØµÙØ­ Ø§Ù„ÙŠÙˆÙ…ÙŠ.">
    <title>ØµÙ„Ø§ØªÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>

    <style>
        :root {
            --primary: #6750a4;
            --secondary: #eaddff;
            --bg: #fef7ff;
            --text: #1c1b1f;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background-color: #f0f0f0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 15px;
            box-sizing: border-box;
        }

        .app-container { 
            background-color: var(--bg);
            width: 100%; 
            max-width: 400px; 
            min-height: 85vh;
            border-radius: 28px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        }

        header { 
            background-color: var(--primary); 
            color: white; 
            padding: 20px; 
            text-align: center; 
            border-radius: 0 0 24px 24px;
        }

        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            margin-bottom: 10px;
            padding: 5px;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px 15px;
            transition: opacity 0.2s;
        }

        .nav-btn:active { opacity: 0.5; }

        .search-container { 
            padding: 15px 20px; 
            display: flex; gap: 8px;
        }

        input[type="text"] {
            flex: 1; padding: 12px; border-radius: 12px;
            border: 2px solid var(--secondary); outline: none; font-size: 1rem;
        }

        .search-btn {
            background: var(--primary); color: white; border: none;
            padding: 0 15px; border-radius: 12px; cursor: pointer; font-weight: bold;
        }

        .prayer-list { flex: 1; padding: 0 20px 20px; }
        
        .prayer-card { 
            background: white; border-radius: 16px; 
            padding: 18px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #eee;
        }

        .p-name { color: var(--primary); font-weight: 600; font-size: 1.1rem; }
        .p-time { color: var(--text); font-weight: bold; font-size: 1.2rem; }
        
        #loader { display: none; color: white; font-size: 0.8rem; margin-top: 5px; }
        .version-tag { text-align: center; font-size: 0.7rem; opacity: 0.4; padding: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="date-nav">
                <button class="nav-btn" onclick="changeDate(-1)">â®</button>
                <div id="display-date" style="font-weight: bold;">Ø§Ù„ÙŠÙˆÙ…</div>
                <button class="nav-btn" onclick="changeDate(1)">â¯</button>
            </div>
            <div id="hijri-date" style="font-size: 0.9rem; opacity: 0.9;">...</div>
            <h2 id="city-display" style="margin: 5px 0; font-size: 1.4rem;">...</h2>
            <div id="loader">Ù…ÙˆØ¬Ù‘Ù‡ Ù„ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰...</div>
        </header>

        <div class="search-container">
            <input type="text" id="city-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" onkeypress="if(event.key === 'Enter') searchCity()">
            <button class="search-btn" onclick="searchCity()">ğŸ”</button>
        </div>

        <div class="prayer-list" id="list"></div>
        <div class="version-tag">Ø¥ØµØ¯Ø§Ø± 1.6.0 - PWA & Dynamic Accuracy</div>
    </div>

    <script>
        let currentOffset = 0;
        let currentCity = "Aleppo";

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker Ù„Ø¯Ø¹Ù… Ø§Ù„ØªØ«Ø¨ÙŠØª (PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            });
        }

        function getFormattedDate(offset) {
            let d = new Date();
            d.setDate(d.getDate() + offset);
            let day = String(d.getDate()).padStart(2, '0');
            let month = String(d.getMonth() + 1).padStart(2, '0');
            return `${day}-${month}-${d.getFullYear()}`;
        }

        function to12H(time) {
            let [h, m] = time.split(':').map(Number);
            let mod = h >= 12 ? 'Ù…' : 'Øµ';
            h = h % 12 || 12;
            return `${h}:${String(m).padStart(2, '0')} ${mod}`;
        }

        function addMinutes(time, mins) {
            let [h, m] = time.split(':').map(Number);
            let d = new Date(); d.setHours(h, m + mins);
            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        async function loadPrayers() {
            const loader = document.getElementById('loader');
            const dateStr = getFormattedDate(currentOffset);
            
            document.getElementById('display-date').innerText = currentOffset === 0 ? "Ø§Ù„ÙŠÙˆÙ…" : dateStr;
            loader.style.display = 'block';

            try {
                const url = `https://api.aladhan.com/v1/timingsByCity/${dateStr}?city=${encodeURIComponent(currentCity)}&country=&method=4`;
                const res = await fetch(url);
                const json = await res.json();
                const d = json.data;
                const t = d.timings;

                // Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰
                const isUmmAlQura = ["Asia/Damascus", "Asia/Riyadh", "Asia/Amman", "Asia/Beirut", "Asia/Kuwait"].some(z => d.meta.timezone.includes(z));
                
                if (isUmmAlQura) {
                    t.Isha = addMinutes(t.Maghrib, 90);
                    t.Fajr = addMinutes(t.Fajr, -2);
                }

                document.getElementById('hijri-date').innerText = `${d.date.hijri.day} ${d.date.hijri.month.ar} ${d.date.hijri.year} Ù‡Ù€`;
                document.getElementById('city-display').innerText = currentCity;

                const names = {Fajr:'Ø§Ù„ÙØ¬Ø±', Sunrise:'Ø§Ù„Ø´Ø±ÙˆÙ‚', Dhuhr:'Ø§Ù„Ø¸Ù‡Ø±', Asr:'Ø§Ù„Ø¹ØµØ±', Maghrib:'Ø§Ù„Ù…ØºØ±Ø¨', Isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡'};
                document.getElementById('list').innerHTML = Object.keys(names).map(k => `
                    <div class="prayer-card">
                        <span class="p-name">${names[k]}</span>
                        <span class="p-time">${to12H(t[k])}</span>
                    </div>
                `).join('');

            } catch(e) {
                document.getElementById('list').innerHTML = "<p style='text-align:center;'>Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>";
            } finally {
                loader.style.display = 'none';
            }
        }

        function changeDate(n) { currentOffset += n; loadPrayers(); }
        
        function searchCity() {
            let val = document.getElementById('city-input').value.trim();
            if(val) {
                currentCity = val;
                currentOffset = 0; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙŠÙˆÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©
                loadPrayers();
            }
        }

        window.onload = () => {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                        const data = await res.json();
                        currentCity = data.address.city || data.address.town || "Aleppo";
                        loadPrayers();
                    },
                    () => loadPrayers()
                );
            } else {
                loadPrayers();
            }
        };
    </script>
</body>
</html>