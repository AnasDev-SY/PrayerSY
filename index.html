<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#6750a4">
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <title>ØµÙ„Ø§ØªÙŠ - Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</title>

    <style>
        :root {
            --primary: #6750a4;
            --secondary: #eaddff;
            --bg: #fef7ff;
            --text: #1c1b1f;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #f0f0f0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 15px; /* Ù…Ø³Ø§ÙØ© Ø£Ù…Ø§Ù† Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ù„ØªØµØ§Ù‚ Ø¨Ø§Ù„Ø­ÙˆØ§Ù */
            box-sizing: border-box;
        }

        .app-container { 
            background-color: var(--bg);
            width: 100%; 
            max-width: 400px; 
            height: auto; 
            max-height: 94vh; 
            border-radius: 28px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; 
            flex-direction: column;
            overflow: hidden;
            margin: auto; /* Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ³Ø· Ø§Ù„Ø¯Ù‚ÙŠÙ‚ */
        }

        header { 
            background-color: var(--primary); 
            color: white; 
            padding: 25px 20px; 
            text-align: center; 
            border-radius: 0 0 24px 24px;
            word-wrap: break-word; 
        }

        #install-btn {
            display: none;
            background: white;
            color: var(--primary);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .search-container { 
            padding: 20px; 
            display: flex; gap: 8px;
            justify-content: center;
        }

        input[type="text"] {
            flex: 1; padding: 12px; border-radius: 12px;
            border: 2px solid var(--secondary); outline: none; font-size: 1rem;
        }

        .search-btn {
            background: var(--primary); color: white; border: none;
            padding: 0 15px; border-radius: 12px; cursor: pointer; font-weight: bold;
        }

        .prayer-list { flex: 1; padding: 0 20px 20px; overflow-y: auto; }
        
        .prayer-card { 
            background: white; border-radius: 16px; 
            padding: 18px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #eee;
        }

        .prayer-name { color: var(--primary); font-weight: 600; font-size: 1.1rem; }
        .prayer-time { color: var(--text); font-weight: bold; font-size: 1.2rem; }
        
        #loader { display: none; color: white; font-size: 0.8rem; margin-top: 5px; }
        #location-status { font-size: 0.9rem; font-weight: bold; margin-top: 5px; display: block;}
        .version-tag { text-align: center; font-size: 0.7rem; opacity: 0.5; padding: 10px; color: var(--text); }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div id="hijri-date" style="font-size: 0.9rem; opacity: 0.9;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <h1 style="margin: 5px 0; font-size: 1.6rem;">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</h1>
            <div id="location-status">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</div>
            <div id="loader">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            <button id="install-btn">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“¥</button>
        </header>

        <div class="search-container">
            <input type="text" id="city-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø¯ÙˆØ±ØªÙ…ÙˆÙ†Ø¯)" onkeypress="if(event.key === 'Enter') fetchBySearch()">
            <button class="search-btn" onclick="fetchBySearch()">Ø¨Ø­Ø«</button>
        </div>

        <div class="prayer-list" id="prayer-list"></div>
        <div class="version-tag">Ø¥ØµØ¯Ø§Ø± 1.1.2</div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log(err));
            });
        }

        const cityMapping = {
            "Ø¯Ù…Ø´Ù‚": "Damascus", "Ø¯ÙŠÙ…Ø´Ù‚": "Damascus", "Ø¯ÙˆØ±ØªÙ…ÙˆÙ†Ø¯": "Dortmund",
            "Ø¯Ø±ØªÙ…ÙˆÙ†Ø¯": "Dortmund", "Ø¨Ø±Ù„ÙŠÙ†": "Berlin", "Ø­Ù„Ø¨": "Aleppo",
            "Ù…ÙƒØ©": "Mecca", "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©": "Medina", "Ø§Ø³Ø·Ù†Ø¨ÙˆÙ„": "Istanbul", "Ø¥Ø³Ø·Ù†Ø¨ÙˆÙ„": "Istanbul"
        };

        function convertTo12Hour(time) {
            let [hours, minutes] = time.split(':');
            hours = parseInt(hours);
            const modifier = hours >= 12 ? 'Ù…' : 'Øµ';
            hours = hours % 12 || 12;
            return `${hours}:${minutes} ${modifier}`;
        }

        window.onload = () => startApp();

        async function startApp() {
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000, // Ø§Ù†ØªØ¸Ø± 10 Ø«ÙˆØ§Ù†Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        const cityName = await getCityNameFromCoords(lat, lng);
                        fetchPrayers(lat, lng, true, cityName);
                    },
                    (err) => {
                        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", err);
                        let message = "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†ØªÙƒ ÙŠØ¯ÙˆÙŠØ§Ù‹";
                        if (err.code === 1) message = "ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­";
                        if (err.code === 2) message = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ GPS";
                        
                        document.getElementById('location-status').innerText = message;
                        // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ø¯ÙŠÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù€ GPS
                    },
                    options
                );
            } else {
                document.getElementById('location-status').innerText = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
            }
        }

        async function getCityNameFromCoords(lat, lng) {
            try {
                const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=ar`);
                const data = await res.json();
                return data.city || data.locality || data.principalSubdivision || "Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ";
            } catch (e) { 
                return "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"; 
            }
        }

        async function fetchBySearch() {
            let query = document.getElementById('city-input').value.trim();
            if (!query) return;
            const fixedCity = cityMapping[query] || query;
            fetchPrayers(null, null, false, fixedCity);
        }

        async function fetchPrayers(lat, lng, isGPS, cityQuery = "") {
            const loader = document.getElementById('loader');
            const status = document.getElementById('location-status');
            const list = document.getElementById('prayer-list');
            loader.style.display = 'block';
            
            let url = isGPS 
                ? `https://api.aladhan.com/v1/timingsByAddress?address=${lat},${lng}&method=1`
                : `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(cityQuery)}&country=&method=1`;

            try {
                const response = await fetch(url);
                const result = await response.json();
                if (result.code !== 200) throw new Error();

                const data = result.data;
                document.getElementById('hijri-date').innerText = 
                    `${data.date.hijri.day} ${data.date.hijri.month.ar} ${data.date.hijri.year} Ù‡Ù€`;
                
                status.innerText = isGPS ? `ğŸ“ ${cityQuery}` : `ğŸ™ï¸ ${cityQuery}`;

                const prayerNames = {'Fajr': 'Ø§Ù„ÙØ¬Ø±', 'Sunrise': 'Ø§Ù„Ø´Ø±ÙˆÙ‚', 'Dhuhr': 'Ø§Ù„Ø¸Ù‡Ø±', 'Asr': 'Ø§Ù„Ø¹ØµØ±', 'Maghrib': 'Ø§Ù„Ù…ØºØ±Ø¨', 'Isha': 'Ø§Ù„Ø¹Ø´Ø§Ø¡'};
                let html = '';
                for (let key in prayerNames) {
                    html += `<div class="prayer-card">
                        <span class="prayer-name">${prayerNames[key]}</span>
                        <span class="prayer-time">${convertTo12Hour(data.timings[key])}</span>
                    </div>`;
                }
                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = '<p style="text-align:center; color:red; padding:20px;">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ù†Ø¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¯Ù‚ÙŠÙ‚Ø©.</p>';
            } finally {
                loader.style.display = 'none';
            }
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('install-btn');
            if (btn) btn.style.display = 'inline-block';
        });

        document.getElementById('install-btn')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-btn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });
    </script>
</body>
</html>
